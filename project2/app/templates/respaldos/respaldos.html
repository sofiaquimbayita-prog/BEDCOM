{% extends "includes/base.html" %}
{% load static %}
{% block header_title %}Respaldos {% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'ap1/css/respaldos.css' %}">
{% if messages %}
<div class="messages-container" id="toast-container">
    {% for message in messages %}
    <div class="message {{ message.tags }}">
        <div class="message-content">
            {% if message.tags == 'success' %}
                <i class="fas fa-check-circle"></i>
            {% else %}
                <i class="fas fa-exclamation-circle"></i>
            {% endif %}
            <span class="text">{{ message }}</span>
        </div>
        <button type="button" class="close-toast" onclick="cerrarToast(this)">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endfor %}
</div>
{% endif %}

<main class="content">
    <div class="card main-card-dark">
        <div class="toolbar-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <h2 class="section-title" style="margin: 0;"><i class="fas fa-database"></i> Gestión de Respaldos</h2>
            
            <div class="header-actions">
                <label class="search" aria-label="Buscar" for="searchInput">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="search" id="searchInput" placeholder="Buscar en el historial...">
                </label>

                <div class="filter-switch">
                    <span>Ver Inactivos</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleInactivos">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="decor-line"></div>

        <div class="stats-cards">
            <div class="small-card total">
                <div class="label">Total Registros</div>
                <div class="value">{{ respaldos|length }}</div>
            </div>
            <div class="small-card last">
                <div class="label">Último Tipo</div>
                <div class="value">{% if respaldos %}{{ respaldos.0.tipo_respaldo|capfirst }}{% else %}-{% endif %}</div>
            </div>
            <div class="small-card recent">
                <div class="label">Fecha Reciente</div>
                <div class="value">{% if respaldos %}{{ respaldos.0.fecha|date:'d/m/Y' }}{% else %}-{% endif %}</div>
            </div>
        </div>

        <div class="action-bar" style="margin: 25px 0; text-align: right;">
            <button type="button" class="btn-generar primary" onclick="abrirModal('generarModal')">
                <i class="fas fa-plus-circle"></i> NUEVO RESPALDO
            </button>
        </div>

        <div class="table-container">
            <table class="respaldos-table" id="respaldosTable">
                <thead>
                    <tr>
                        <th>Fecha y Hora</th>
                        <th>Usuario</th>
                        <th>Tipo</th>
                        <th>Descripción</th>
                        <th style="text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in respaldos %}
                    <tr class="respaldo-row {% if not r.estado %}inactive-row{% endif %}">
                        <td>{{ r.fecha|date:'d/m/Y H:i' }}</td>
                        <td><i class="fas fa-user-shield" style="font-size: 0.8rem; color: #94a3b8;"></i> {{ r.usuario }}</td>
                        <td>
                            <span class="badge-movimiento badge-{{ r.tipo_respaldo|lower }}">
                                {{ r.tipo_respaldo|upper }}
                            </span>
                        </td>
                        <td>{{ r.descripcion|truncatechars:40|default:"-" }}</td>
                        <td style="text-align: center;">
                            <div class="table-actions" style="display: flex; justify-content: center; gap: 15px;">
                                <i class="fa-regular fa-eye" 
                                   onclick="openViewModal('{{ r.fecha|date:'d/m/Y H:i' }}', '{{ r.usuario|escapejs }}', '{{ r.tipo_respaldo|escapejs }}', '{{ r.descripcion|escapejs }}')"
                                   title="Ver detalles" style="cursor:pointer; color: #38bdf8; font-size: 1.1rem;"></i>
                                
                                {% if r.estado %}
                                    <a href="{% url 'descargar_respaldo' r.id %}" title="Descargar SQL">
                                        <i class="fas fa-file-download" style="cursor:pointer; color: #10b981; font-size: 1.1rem;"></i>
                                    </a>

                                    <i class="fa-regular fa-trash-can" 
                                       onclick="openDeleteModal('{{ r.id }}', '{{ r.fecha|date:'d/m/Y H:i' }}')"
                                       title="Eliminar" style="cursor:pointer; color: #ef4444; font-size: 1.1rem;"></i>
                                {% else %}
                                    <i class="fas fa-undo-alt" 
                                       onclick="openRestoreModal('{{ r.id }}', '{{ r.fecha|date:'d/m/Y H:i' }}')"
                                       title="Restaurar" style="cursor:pointer; color: #10b981; font-size: 1.1rem;"></i>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-row">
                        <td colspan="5" style="text-align: center; padding: 50px; color: #64748b;">
                            <i class="fas fa-folder-open" style="display: block; font-size: 2.5rem; margin-bottom: 10px; opacity: 0.2;"></i>
                            No hay respaldos registrados.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<div id="generarModal" class="modal" style="display: none;">
    <div class="modal-content">
        {% include "respaldos/modal_generar.html" %}
    </div>
</div>

<div id="viewModal" class="modal" style="display: none;">
    <div class="modal-content">
        {% include "respaldos/modal_view.html" %}
    </div>
</div>

<div id="deleteModal" class="modal" style="display: none;">
    {% include "respaldos/modal_delete.html" %}
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="{% static 'ap1/js/respaldos.js' %}?v={% now 'U' %}"></script>

{% endblock %}